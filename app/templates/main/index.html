{% extends "base.html" %}
{% block content %}

<!-- Websocket -->
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

<input type="hidden" id="currentUserId" value="{{ current_user.id }}">
<input type="hidden" id="isAdmin" value="{{ 'true' if current_user.is_admin() else 'false' }}">

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let messageInput = document.querySelector("#messageForm textarea");
        if (messageInput) {
            messageInput.focus(); // ðŸ”¹ Autofocus on load
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        const messageInput = document.getElementById("messageForm").elements["content"];

        messageInput.addEventListener("keydown", function (event) {
            if (event.key === "Enter" && !event.shiftKey) { // ðŸ”¹ Shift + Enter adds a new line, Enter sends
                event.preventDefault(); // ðŸ”¹ Prevents line breaks
                sendMessage(); // ðŸ”¹ Calls `sendMessage()`
            }
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        // Define WebSocket before using it elsewhere
        window.socket = io({ transports: ["websocket"] });

        socket.on("connect", function () {
            console.log("WebSocket connected successfully!");
        });

        socket.on("message_received", function (msg) {
            const currentUserId = document.getElementById("currentUserId").value;

            let newMsg = document.createElement("div");
            newMsg.classList.add("message", msg.user_id == currentUserId ? "sent" : "received");
            newMsg.dataset.id = msg.id;

            const deleteButton = (msg.user_id == currentUserId || document.getElementById("isAdmin").value === "true") 
                ? `<button type="button" class="btn btn-danger btn-sm" onclick="deleteMessage('/delete_message/${msg.id}')">Delete</button>` 
                : "";

            newMsg.innerHTML = `
                <strong>${msg.username}:</strong> ${msg.content}  
                <small class="text-muted">(${msg.timestamp})</small>  
                ${deleteButton}
            `;

            const chatBox = document.getElementById("messagesDisplay");

            // Check if user is at the bottom before auto-scrolling
            const isAtBottom = chatBox.scrollHeight - chatBox.scrollTop <= chatBox.clientHeight + 50;

            chatBox.appendChild(newMsg);

            if (isAtBottom) {
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        });

        socket.on("message_deleted", function (data) {
            let deletedMsg = document.querySelector(`.message[data-id="${data.message_id}"]`);
            if (deletedMsg) {
                let timestampElement = deletedMsg.querySelector("small"); // ðŸ”¹ Capture existing timestamp

                if (!timestampElement) {
                    timestampElement = document.createElement("small");
                    timestampElement.classList.add("text-muted");
                    timestampElement.innerHTML = `(${data.timestamp})`;
                    deletedMsg.appendChild(timestampElement);
                }

                let textContainer = deletedMsg.querySelector("strong"); // ðŸ”¹ Target only the message text
                if (textContainer) {
                    textContainer.innerHTML = `<i>ðŸš« Message deleted</i>`;  // ðŸ”¹ Replace only message text
                }

            }
        });     

        socket.on("error", function (error) {
            console.error("WebSocket error:", error);
        });

        socket.on("disconnect", function () {
            console.log("WebSocket disconnected. Attempting to reconnect...");
            setTimeout(() => { socket.connect(); }, 5000); // Reconnect after 5 seconds
        }); 
    });
</script>


<!-- JavaScript Section -->

<script>

    function setDeleteAction(actionUrl) {
        const form = document.getElementById('deleteMessageForm');
        form.action = actionUrl;
    }

    function sendMessage() {
        const messageContent = document.getElementById("messageForm").elements["content"].value;
        const userId = document.getElementById("currentUserId").value;

        if (!messageContent.trim()) return;

        // Send WebSocket message first
        socket.emit("new_message", { user_id: userId, content: messageContent });

        // Send message via AJAX but **DO NOT APPEND** (WebSocket will handle display)
        const formData = new FormData(document.getElementById("messageForm"));
        fetch('{{ url_for("main.index") }}', {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status !== "success") {
                console.error("Failed to send message.");
            }
            document.getElementById("messageForm").reset();
        })
        .catch(error => console.error("Error sending message:", error));
        
    }
        
    function deleteMessage(deleteUrl) {
        fetch(deleteUrl, {
            method: "POST",
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status !== "success") {
                console.error("Failed to delete message.");
                return;
            }

            let deletedMsg = document.querySelector(`.message[data-id="${data.message_id}"]`);
            if (deletedMsg) {
                let timestampElement = deletedMsg.querySelector("small"); 
                let timestampHTML = timestampElement ? timestampElement.outerHTML : `<small class="text-muted">(${data.timestamp})</small>`;

                let textContainer = deletedMsg.querySelector("strong");
                if (textContainer) {
                    textContainer.innerHTML = `<i>ðŸš« Message deleted</i>`;
                } else {
                    deletedMsg.innerHTML = `<i>ðŸš« Message deleted</i> ${timestampHTML}`;
                }

                let deleteButton = deletedMsg.querySelector("button"); // ðŸ”¹ Find delete button
                if (deleteButton) {
                    deleteButton.remove(); // ðŸ”¹ Remove the delete button
                }
            }
        })
        .catch(error => console.error("Error deleting message:", error));
    }

    document.addEventListener("DOMContentLoaded", function () {
        const chatBox = document.getElementById("messagesDisplay");

        chatBox.addEventListener("scroll", function () {
            if (chatBox.scrollTop <= 10) { // Near the top
                loadMoreMessages();
            }
        });
        

        function loadMoreMessages() {
            const firstMessage = document.querySelector(".message:first-child");

            if (!firstMessage) return;

            const firstMessageId = firstMessage.dataset.id;
            if (!firstMessageId) {
                console.error("Invalid firstMessageId:", firstMessageId);
                return;
            }

            fetch(`/load_messages?last_message_id=${firstMessageId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error("Error loading messages:", data.error);
                        return;
                    }

                    const chatBox = document.getElementById("messagesDisplay");
                    const previousHeight = chatBox.scrollHeight;

                    data.forEach(msg => {
                        let newMsg = document.createElement("div");
                        newMsg.classList.add("message");
                        newMsg.dataset.id = msg.id;
                        newMsg.innerHTML = `<strong>${msg.username}:</strong> ${msg.content}`;
                        chatBox.prepend(newMsg); // Prepend normally
                    });

                    chatBox.scrollTop = chatBox.scrollHeight - previousHeight; // Maintain scroll position
                })
                .catch(error => console.error("Failed to load messages:", error));
        }

            // Auto-scroll to the bottom when the page loads
            chatBox.scrollTop = chatBox.scrollHeight;
        });
</script>



<!-- Header Section -->
<div class="container text-center mt-5">
    <h1>Welcome to the Jones HQ Dashboard!</h1>
</div>


<!-- Message Board Section -->
<div id="messageBoardPage" class="container text-center mt-5">
    <h1>Message Board</h1>

    <!-- Messages Display -->
    <div id="messagesDisplay">
        {% for message in messages %}
            <div class="message {% if message.user_id == current_user.id %} sent {% else %} received {% endif %}" data-id="{{ message.id }}">
                {% if message.deleted %}
                    <i>ðŸš« Message deleted</i>  <!-- ðŸ”¹ Display deletion notice -->
                {% else %}
                    <strong>{{ message.user.username }}:</strong> {{ message.content }}
                {% endif %}
                <small class="text-muted">({{ message.timestamp.strftime("%d-%m-%Y @ %H:%M:%S") }})</small>

                {% if not message.deleted and (message.user_id == current_user.id or current_user.is_admin()) %}
                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteMessage('/delete_message/{{ message.id }}')">Delete</button>
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <!--Send Message Form -->
    <div id="messageFormContainer" class="mb-4">
        <form id="messageForm" class="d-flex">
            {{ form.hidden_tag() }}
            {{ form.content(class="form-control flex-grow-1", placeholder="Write your message here...", rows=3) }}
            <button type="button" class="btn btn-primary" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
</div>

    

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this message? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteMessageForm" method="POST" action="">
                    {{ form.hidden_tag() }}
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}
